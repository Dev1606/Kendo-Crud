@model List<WebApi.Models.EmpModel>
@{
    Layout = "~/Views/Shared/_ApiLayout.cshtml";
    ViewData["Title"] = "Index Of MVC API";
}

<h1>@ViewData["Title"]</h1>

<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.2.616/styles/kendo.common.min.css" />
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.2.616/styles/kendo.default.min.css" />
<div id="grid"></div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2021.2.616/js/kendo.all.min.js"></script>
    <script>
        $(document).ready(function () {
            var dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "https://localhost:7068/api/MVCApi/GetEmpData",
                        dataType: "json",
                        headers: {
                            Authorization: 'Bearer ' + localStorage.getItem('token')
                        }
                    },
                    update: {
                        url: "https://localhost:7068/api/MVCApi/UpdateKendoEmpData",
                        type: "PUT",
                        contentType: false,
                        processData: false,
                        headers: {
                            Authorization: 'Bearer ' + localStorage.getItem('token')
                        }
                    },
                    destroy: {
                        url: function (data) {
                            return "https://localhost:7068/api/MVCApi/DeleteEmpData?id=" + data.c_empid;
                        },
                        type: "DELETE",
                        contentType: "application/json",
                        headers: {
                            Authorization: 'Bearer ' + localStorage.getItem('token')
                        }
                    },
                    parameterMap: function (options, operation) {
                        if (operation !== "read" && options.model) {
                            console.log(options);
                            var formData = new FormData();
                            for (var prop in options) {
                                if (prop === 'Image') {
                                    // Append the file to the form data with the correct name
                                    formData.append('Image', options[prop], options[prop].name);
                                } else {
                                    formData.append(prop, options[prop]);
                                }
                            }
                            console.log(formData);
                            return formData;
                        }
                        return options;
                    }

                },
                pageSize: 10,
                schema: {
                    model: {
                        id: "c_empid",
                        fields: {
                            c_empid: { type: "number", editable: false, nullable: false },
                            c_empname: { type: "string", validation: { required: true } },
                            c_empgender: { type: "string", validation: { required: true } },
                            c_dob: { type: "string", validation: { required: true } },
                            c_shift: { type: "string", validation: { required: true } },
                            c_department: { type: "string", validation: { required: true } },
                            c_empimage: { type: "string", validation: { required: true } },
                        }
                    }
                }
            });
            $("#grid").kendoGrid({
                dataSource: dataSource,
                columns: [
                    { field: "c_empid", title: "Emp ID" },
                    { field: "c_empname", title: "Emp Name" },
                    {
                        field: "c_empgender", title: "Gender", editor: function (container, options) {
                            $('<input id="male" type="radio" name="' + options.field + '" value="Male" selectable="true" />').appendTo(container);
                            $('<label for="male">Male</label>').appendTo(container);
                            $('<input id="Female" type="radio" name="' + options.field + '" value="Female"/>').appendTo(container);
                            $('<label for="Female">Female</label>').appendTo(container);
                        }
                    },
                    {
                        field: "c_dob",
                        title: "DOB",
                        editor: function (container, options) {
                            // var dob = options.model.c_dob;
                            // console.log("DOB",dob);
                            $(container).kendoCalendar({
                                componentType: "modern",
                                format: "yyyy/MM/dd",
                                change: function () {
                                    console.log("Change :: " + kendo.toString(this.value(), 'yyyy/MM/dd'));
                                    options.model.set("c_dob", kendo.toString(this.value(), 'yyyy/MM/dd'));
                                },
                                navigate: function () {
                                    console.log("Navigate");
                                }
                            });
                            // $(container).kendoCalendar("value", dob);
                        },
                        template: function (dataItem) {
                            var dob = kendo.toString(kendo.parseDate(dataItem.c_dob), "yyyy-MM-dd");
                            return dob;
                        }
                    },
                    {
                        field: "c_shift", title: "Shift", editor: function (container, options) {
                            var shiftValues = options.model.c_shift.split(",");
                            $(container).kendoCheckBoxGroup({
                                items: ["Morning", "Afternoon", "Night"],
                                layout: "horizontal",
                                change: function () {
                                    var selectedValues = $(container).kendoCheckBoxGroup("value")
                                    console.log(selectedValues);
                                    var arrayExpression = `${selectedValues.join(",")}`;
                                    options.model.set("c_shift", arrayExpression);
                                    console.log("c_shift", arrayExpression);
                                }
                            });
                            $(container).kendoCheckBoxGroup("value", shiftValues);
                        }
                    },
                    {
                        field: "c_department", title: "Department", editor: function (container, options) {
                            $('<input name="' + options.field + '" id="stateDropdown" checked="checked" optionLabel="Select" style="width: 100%;" />').appendTo(container).kendoDropDownList({
                                dataSource: {
                                    transport: {
                                        read: "https://localhost:7068/api/MVCApi/GetDropDepartment",
                                        datatype: "json",
                                        headers: {
                                            Authorization: 'Bearer ' + localStorage.getItem('token')
                                        }
                                    }
                                },
                            });
                        }
                    },
                    {
                        field: "c_empimage", title: "Image", editor: function (container, options) {
                            imageupload(container, options);
                        }, template: "<img src='/uploadsimg/#= c_empimage #' alt='Employee Photo' style='width: 50px; height:50px;'/>" 
                    },
                    { command: ["edit", "destroy"], title: "&nbsp;", width: "200px" }],
                editable: "popup",
                pageable: true,
                sortable: true,
                filterable: true,
                edit: function (e) {
                    var dataItem = e.model;
                    var dob = kendo.parseDate(dataItem.c_dob);
                    e.container.find(".k-calendar").data("kendoCalendar").value(dob);
                }
            });
            function imageupload(container, options) {
                // Create the file input element
                var fileInput = $('<input name="Image" type="file" id="photo" data-role="upload" data-async=\'{ "saveUrl": "/kendogrid/UploadPhoto", "autoUpload": true }\' class="k-input k-textbox">');
                fileInput.appendTo(container);
                fileInput.on('change', function () {
                    var file = this.files[0];
                    c_empimage = file.name;
                    console.log('Selected file:', c_empimage);
                    console.log('Selected file:', file.name);
                    options.model.set("c_empimage", file.name);
                    console.log("c_empimage", file.name);
                });
            }
            dataSource.bind("requestEnd", function (e) {
                if (e.type === "update" || e.type === "destroy") {
                    dataSource.read();
                }
            });
            $("#grid").on("click", ".k-grid-cancel-changes", function () {
                dataSource.cancelChanges();
            });
        });
    </script>
}