@model WebApi.Models.LoginModel

@{
    ViewData["Title"] = "Login";
}

<div class="row justify-content-center">
    <div class="col-md-6">
        <h2>Login</h2>
        <form method="POST">
            <div class="mb-3">
                <label for="inputEmail" class="form-label">Email address</label>
                <input type="email" class="form-control" id="inputEmail" placeholder="Email" />
            </div>
            <div class="mb-3">
                <label for="inputPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="inputPassword" placeholder="Password" />
            </div>

            <button type="button" class="btn btn-primary" onclick="Login()" id="loginBtn">Login</button>

            <a class="btn btn-primary" href="/UserApi/Register">Register</a>

        </form>
    </div>
</div>

@section Scripts {

    <script>

        function Login() {
            var user = {
                c_uemail: $('#inputEmail').val(),
                c_password: $('#inputPassword').val()
            }

            $.ajax({
                url: 'https://localhost:7068/api/UserApi/Login',
                method: 'POST',
                timeout: 0,
                contentType: 'application/json',
                data: JSON.stringify(user),
                success: function (data) {
                    if (data.success == true) {
                        alert('Successfully Logged In!');
                        localStorage.setItem('token', data.tokenStr);
                        fetchUserData(data.tokenStr);
                        console.log(data);
                        @* window.location.href = "/ApiAjax/Index";
                        if (data.role == 1) {
                            console.log(data);
                            window.location.href = "/ApiAjax/Index";
                        } 
                        else {
                            console.log(data);
                            window.location = "/ApiAjax/UserIndex";
                        } *@
                    }
                }
            });
        }

        
        function fetchUserData(token) {
            var username = "";
            var role = "";
            $.ajax({
                url: 'https://localhost:7068/api/MVCApi/GetTokenData',
                type: 'GET',
                data: { usertoken: token },
                success: function (userData) {
                    console.log('User Data:', userData);
                    username = userData.userName;
                    role = parseInt(userData.role);
                    $.ajax({
                        url: "/User/SetUserData",
                        method: "POST",
                        data: { username: username, role: role },
                        async: false,
                        success: function (response) {
                            if (response.success) {
                                @* window.location.href = "/ApiAjax/Index"; *@
                                if (response.role == 1) {
                                    console.log(response);
                                    window.location.href = "/ApiAjax/Index";
                                } 
                                else {
                                    console.log(response);
                                    window.location = "/ApiAjax/UserIndex";
                                }
                                // Handle successful response, e.g., display a success message
                                console.log("Username set successfully!");
                            } else {
                                // Handle unsuccessful response, e.g., display an error message
                                console.error("Failed to set username.");
                            }
                        }
                    });
                }
            });

        }
        
    </script>
}
